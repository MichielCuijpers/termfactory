# Licensed under the Apache License: http://www.apache.org/licenses/LICENSE-2.0
# For details: https://github.com/nedbat/coveragepy/blob/master/NOTICE.txt

name: "Coverage"

on:
  # As currently structured, this adds too many jobs (checks?), so don't run it
  # on pull requests yet.
  push:
    branches:
      - master
      - "**/*metacov*"
  workflow_dispatch:

env:
  PIP_DISABLE_PIP_VERSION_CHECK: 1

jobs:
  coverage:
    name: "Python 3.9 on Ubuntu"
    container: python:3.9
    runs-on: ci

    steps:
      - name: "Check out the repo"
        uses: "actions/checkout@v3"

      - name: "Set up Python"
        uses: "actions/setup-python@v3"
        with:
          python-version: 3.8.10
          cache: pip
          cache-dependency-path: "$CI_PROJECT_DIR/.cache/pip"

      - name: "Install dependencies"
        run: |
          - python -V               # Print out python version for debugging
          - python -m pip install virtualenv >> setup_output.txt
          - virtualenv venv  >> setup_output.txt
          - source venv/bin/activate
          - python -m pip install -r requirements.txt >> setup_output.txt
          - python -m pip install -r test_requirements.txt >> setup_output.txt
      - name: "Run tot coverage for 3.9"
        run: |
          - python -m coverage run -m pytest -k 'deep' >> printing_output.txt # only run deep tests (1 ~ 3 seconds long)
          - python -m coverage html
          - python -m coverage report
      - name: "Upload coverage data"
        uses: actions/upload-artifact@v3
        with:
          name: htmlcov
          path: /htmlcov/*
